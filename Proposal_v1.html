<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>proposal_v1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Proposal_v1_files/libs/clipboard/clipboard.min.js"></script>
<script src="Proposal_v1_files/libs/quarto-html/quarto.js"></script>
<script src="Proposal_v1_files/libs/quarto-html/popper.min.js"></script>
<script src="Proposal_v1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Proposal_v1_files/libs/quarto-html/anchor.min.js"></script>
<link href="Proposal_v1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Proposal_v1_files/libs/quarto-html/quarto-syntax-highlighting-01c78b5cd655e4cd89133cf59d535862.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Proposal_v1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Proposal_v1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Proposal_v1_files/libs/bootstrap/bootstrap-933a14f46f0e4d1503cecf416b5e09b4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<table class="caption-top table">
<colgroup>
<col style="width: 4%">
</colgroup>
<tbody>
<tr class="odd">
<td>title: “A Predictive and Casual Analysis of Contributing Factors in 4th Down Attempt Conversions in the NFL” author: “Simon Raymond” date: “2024-12-04” department: “Economics” format: pdf: toc: true number-sections: true fontsize: 11pt code-block-font-size: 5pt</td>
</tr>
</tbody>
</table>
<p>and Casual Analysis of Contributing Factors in 4th Down Attempt Conversions in the NFL.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>The NFL is a multi-billion dollar industry that has seen rapid growth within the USA and internationally. This growth has placed more and more importance on the performance of NFL teams as they fight to win games to increase in popularity of their team. We have seen in the NFL that their has been a surge in teams trying to find strategies that increase there chances of winning (reference). One such area that has received much attention is the idea of maximizing the expected win percentages of teams. This leads teams to look to strategies that may by outside of the culture norm.</p>
<p>In the NFL their seemed to be a consistent standard that on 4th down your team will kick a field goal or punt the ball for better field position. The only exception being the dying moments in a game when teams are desperate. However we have seen a increase in the overall attempt percentage of teams on 4th down (reference my app). This is signalling a change in culture</p>
<p>In the NFL there has been a increasing feeling that teams need to be more aggressive on 4th downs. We have seen teams adopt this stra # Abstract {.unnumbered}</p>
</section>
</section>
<section id="introduction-1" class="level1">
<h1>Introduction</h1>
<section id="background-1" class="level2">
<h2 class="anchored" data-anchor-id="background-1">Background</h2>
<p>The NFL is a multi-billion dollar industry that has seen rapid growth within the USA and internationally. This growth has placed more and more importance on the performance of NFL teams as they fight to win games to increase in popularity of their team. We have seen in the NFL that their has been a surge in teams trying to find strategies that increase there chances of winning (reference). One such area that has received much attention is the idea of maximizing the expected win percentages of teams. This leads teams to look to strategies that may by outside of the culture norm.</p>
<p>In the NFL their seemed to be a consistent standard that on 4th down your team will kick a field goal or punt the ball for better field position. The only exception being the dying moments in a game when teams are desperate. However we have seen a increase in the overall attempt percentage of teams on 4th down (reference my app). This is signalling a change in culture</p>
<p>In the NFL there has been a increasing feeling that teams need to be more aggressive on 4th downs. We have seen teams adopt this strategy. Most famously is the Detroit lions mentality since the arrival of their current head coach Dan Campbell. Then lions adopted a aggressive strategy to match their aggressive “biting off knee caps” mentality. While the lions have seen success for the first time in X amount of years they have also been criticized for their aggressive play calling. This was seen in the 20XX X playoff game in which the lions failed a 4th down attempt that was painted as “unnecessary” (reference). After this failed 4th down attempt there seemed to be a shift in momentum and the lions lost the game.</p>
</section>
<section id="research-problem" class="level2">
<h2 class="anchored" data-anchor-id="research-problem">Research Problem</h2>
<p>A result like this makes us ask the question “did the lions make the right call”. This question seems to be getting answered as “yes” by the current literature on this topic. However, we need to know if different teams should go for it or not go for it depending on their situation and team build. For example it could be argued that the lions should have attempted the crucial 4th down in the 20XX X game. However if the panthers (which were a significantly worse team) where is that situation it could be argued that they should not have been as aggressive. This is because mabye the panthers had a worse chance of being able to convert on 4th down.</p>
<p>On top of this we must be weary of any recommendation that is given to a head coach. The truth is that we are not on the field, in the locker rooms, or in team meeting. This means coaches my know more then us in certain game time decision. We must approach this topic with the idea of being more practical and clear to coaches.</p>
</section>
<section id="research-questions" class="level2">
<h2 class="anchored" data-anchor-id="research-questions">Research Questions</h2>
<p>This leads us to have a need to answer some key questions about 4th downs in the NFL. First is are there certain key predictable signals that can be used to decide if a given team should attempt a 4th down. Second, is what key factors or variables about players have predictive power in 4th down attempts. In other words are there players that are more important in 4th down situations when compared to other situations. Finally. do these key factors about players have a casual effect on the outcome of 4th down attempts? Answering these questions will allow coaches to look for key signals in 4th down situations and to know which players to start on that 4th down if it is decided to attempt. This also can be applied in discovering specialty players that are overlooked due to poor performances in situations that are not similar to 4th down.</p>
</section>
</section>
<section id="literature-review" class="level1">
<h1>Literature Review</h1>
<ul>
<li>Risk aversion<br>
</li>
</ul>
<p>Much of this problem revolves around the idea that NFL coaches are acting overly averse to risk which is lowering their expected wins. Romer (2006) found that teams had begun to move towards a more conservative or safe strategy in the NFL. He argues that teams value successful gambles more then the expected win percentage in a game. He theorizes that the poor decision making is either due to risk aversion or it is due to poor information.</p>
<p>Goff and Locke (2019) found when revisiting Romer’s framework that Romer’s core findings are still held to be true. However they argue that overly conservative calls are not due to poor decision making. Instead they point to risk aversion as they estimate that coaches are willing to give up two-thirds of a expected point to avoid the uncertainty of fourth down attempts</p>
<p>On top of this there seems to be evidence that coaches are more cautious when their job is on the line. Owens and Roach (2018) found that in the NCAA coaches are relatively more conservative when they are more likely to be fired. At the same time they found when a coach was likely to be promoted that the coach is more aggressive then normal.</p>
<p>Lehman &amp; Hahn (2013) looked to identify momentum across and within games in the NFL. Within-period momentum was found to encourage teams to take more risks. Negative within-period momentum was in-turn found to encourage teams to take less risks. It was also discovered that across-period momentum has a effect only until a within period momentum was established in a game.</p>
<ul>
<li>Momentum<br>
</li>
</ul>
<p>If a team feels to be “on fire” should they be more aggressive since they feel to have momentum? The most famous literature in this are is the fallacy of the “hot hand”. The hot hand is a cognitive bias that leads people to believe that a person who has a successful outcome is more likely to have a successful outcome in future attempts. Gilovich et al.&nbsp;(1985) investigated the “hot hand” and “shooting streaks” in basket ball. They found that both players and fans believed in the fallacy despite shots being independent of each other. Losak et al.&nbsp;(2023) similarly discovered that fantasy baseball users gravitated towards “hot” players. At the same time they were unable to identify a viable hot hand strategy in DraftKings DFS baseball.</p>
<p>Despite these common findings there does seem to be some evidence of momentum existing in the NFL.</p>
<p>Roebber et al.(2022, p.&nbsp;2) defined momentum in the NFL as “the sustained increase in win probability by a single team over the course of at least 2 successive changes in possession”. With this definition they found that streaks of win probability in football are non-random and are in fact predictable with Artificial Neural Network Models.</p>
<ul>
<li>Heckman correction (spend a lot more time on this)&nbsp;</li>
</ul>
<p>Klein and Spady’s (1993) estimator</p>
<p>Das, Newey, and Vella (2003) they work with non linear</p>
<section id="research-gap" class="level2">
<h2 class="anchored" data-anchor-id="research-gap">Research Gap</h2>
<p>The gap in the current research that revolves around the gap in quality data. Currently we see many studies include team grades or summary statistics about teams that are playing against each other. This type of generalization is needed for econometric tools. However, our non-parametric models will be able to handle data with thousands of different variables. To take advantage of this we will have information about every single player that is on the field when the ball is snapped. This will allow us to have better prediction power then previous reasearchers. This lack of work with highly specific data then in turn creates a lack in researchers identifying key variables about different players in the feild. This is why our combined approach of predictive and casual tools will be so effective. We will be able to see what variable are or are not having a effect on 4th down conversions.</p>
</section>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<ul>
<li>PBP<br>
</li>
</ul>
<p>Our data consists of play by play data from the NFL. This data is pulled from the nfl verse package in R (reference). The data ranges from 2016 to 2023. The reason for this is that after 2016 the NFL started to put tracking chips in NFL player’s jerseys. This gives us information after 2016 of what players are on the field for each snap. As a note a weeks x-x in 202X are missing and the data in 2016 is described as not as reliable (reference).</p>
<p>To create my data I have merged play by play data, participation data, roster data, and injury data. However we will have different versions of our data sets that will be used with our casual model and its supporting arguments</p>
<p>First we have a third down data set. This data has the purpose of allowing us to test our Heckman Variable’s validity in showing that a variable has no predictive power on a third down conversion. We then use this to bolster our argument that the variable in question has no predictive power on a 4th down conversions. We also will have a fourth down “attempts” data set. This data set will be used to show that our Heckman Correction variable does have strong prediction power on the decision to attempt a 4th down or not. (this situation is more unbalanced). Finally the end goal is to be using data of purely 4th down attempts to predict the conversion of a play.</p>
<ul>
<li>PFF<br>
</li>
</ul>
<p>Our weekly player data is a combination of reports from Pro Football Focus (PFF) from 2016 to 2023. This data is downloaded in the form of different positional reports. For example we downloaded the receiving reports labeled as “Receiving Grades, Receiving Depth, Receiving Concept, and Receiving vs Scheme”. Each row in these reports would be how a player did in certain areas covered by that report that week. This however is useless to us as we needed to merge every report into each other.</p>
<p>We ended up with a data set that is X rows and 14XX columns. Each column is a different stat that may or may not apply to a player (e.g.&nbsp;a receiving grade does not apply to a DE).</p>
<p>So for each row in this engineered data set there is a player, their basic information, the year and week, and X columns of statistics of how that player preformed in a specific week.</p>
<ul>
<li>Merging<br>
</li>
</ul>
<p>The most key aspect of this entire thesis is the merging of these two datasets. We can start with how in our pbp data we have the gsis_ids of every player that was on the field at the time of the play. So we need to take our PFF data and for each player merge it into the pbp data. This creates a data set with X rows and and X columns. The amount of columns is due to the specificness of players on the field. As our project proceeds we will narrow down our specificness if needed.</p>
<p>A problem we are encountering is that the PFF players do not have a gsis_id. They instead have a pff_id. Unfortunately about X of our pbp players are missing a pff id. On top of that the names between the data sets do not always match up. Currently i am working on different methods of matching these players between datasets. This match I currently believe can be done off of parts of names, positions, and teams.</p>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<ul>
<li>Measuring Accuracy</li>
</ul>
<p>In order to measure the accuracy of our models we will be using the area under the curve (AUC) of the ROC curve. This is a common metric used in binary classification problems. The ROC curve is a plot of the true positive rate against the false positive rate for the different possible thresholds of a confusion table. These values will be tested and reported over X tests of bootstrapped test data.</p>
<p>Our methodology involves two main types of tools. These are (1) predictive tools and (2) casual econometrics tools.</p>
<ol type="1">
<li>Predictive tools<br>
</li>
</ol>
<p>These tools are going to be used to predict the outcome of a 4th down attempt. If these outcomes of these predictions are acceptable we will identify what variables had predictive power in our non-parametric models. The models that will be used are Random Forest, GBM boosting, XGBoosting, and possibly Neural Networks. All boosting models will be tuned with some form of grid search.</p>
<ol start="2" type="1">
<li>Casual econometrics tools<br>
</li>
</ol>
<p>After our predictive modeling we will be left with variables that have prediction power on the outcome of a 4th down attempt. Then we turn to our casual econometrics tools. Our situation faces one key problem. There is selection bias around the 4th down attempts. This means that we never see the outcomes of 4th down attempts that never happened. In those situations the ball was punted or a field goal was attempted. To try to control this selection bias we will be using a Heckman correction.</p>
<p>The Heckman correction requires a key variable that predicts 4th attempts but not the results of those attempts. The variable i propose is score differential. The score differential without a doubt has predicting power on whether or not a team attempts a 4th down. The question is does it have prediction power on the actual conversion of the 4th down. I would argue not.</p>
<p>My one fear was originally that score differential signals a “better” team. Then since that team is “better” the 4th down result will receive prediction power from the score differential. However if we account for how good the team are i believe that argument would not hold up. Even without accounting for how good teams are i found that the score differential was almost useless for predicting the 3rd down conversion result (in this case we used 3rd down plays to stand in for 4th down conversions). In my head this is my point. Pretend the panthers (bad team) are playing the saints (average team). the panthers are losing by 30 points so the score differential is -30. Obviously here the panthers probably have a below average chance of conversion on a 4th down. However on 4th down the teams swap and the chiefs (good team) take over for the panthers. I don’t think that it is fair to say that the 30 point deficit will make it harder for the chiefs to convert on 4th down.</p>
<p>This seems to be backed up by the beginnings of my analysis. See the section below.</p>
</section>
<section id="expected-outcomes" class="level1">
<h1>Expected Outcomes</h1>
<p>Currently we are predicting 3rd down conversions with a AUC that is in the mid 60s range. This is awful but makes sense as the baseline predictions only account for some basic situational variables. I expect to have presentable AUC when we work on our properly merged 4th down data set. Then i believe that variables will be identified that will be proven to have a casual effect on 4th down conversions. In this process however it is important to recognize the significance of finding a variable to not have prediction power or a casual effect.</p>
</section>
<section id="timeline" class="level1">
<h1>Timeline</h1>
<ul>
<li>I will have the data merged by next semester (names matching) at the very least</li>
</ul>
</section>
<section id="begining-analysis" class="level1">
<h1>Begining Analysis</h1>
<section id="notes-before-proceeding" class="level2">
<h2 class="anchored" data-anchor-id="notes-before-proceeding">Notes before proceeding</h2>
<ul>
<li>The OLS model takes NO ACCOUNT for Heteroskedasticity (The T vals are very high or low however) or Autocorrelation (wont have a issue with autocorrelation).</li>
<li>The current data ignores how good the teams are (offensive and defensive). For that reason our prediction power doesn’t seem incredible… However the entire point of my thesis is that with the proper data then we can improve our results.</li>
<li>The relationships are definitely non-linear. In some cases though, i could engineer the data to help OLS… for example the minutes left in the game could be two columns one that is the half and one that is the time from 0-30.</li>
<li>i added a random (simulated/useless) variable to the data to give us a reference point of what variables are useless in our random forest model.</li>
<li>Week 1 was removed from the data due to how we created some of the variables.</li>
<li>the ROCR curves are from one run of random forest (double check if I don’t need to loop it because it rf?)</li>
</ul>
</section>
<section id="measures-of-prediction-power-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="measures-of-prediction-power-random-forest">Measures of prediction power Random Forest</h2>
<section id="mdi-gininode-purity" class="level3">
<h3 class="anchored" data-anchor-id="mdi-gininode-purity">MDI (gini/node purity)</h3>
<p>As Gini impurity decreases (meaning nodes become more pure), the MDI value increases.</p>
<p>This measures how good a variable is at promoting node purity during the splits. This is for the training of the model. This leads MDI to not always be the best measure.</p>
<p>That is why the random variable did good in this measure. The splits in the trees will sometimes use useless variables. This is because it fits the training data and it is very normal for RF to use bad predictors (that is the entire point of randomforest). However MDI can make it appear that unimportant variables are in fact important.</p>
</section>
<section id="mda-mean-descrease-in-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="mda-mean-descrease-in-accuracy">MDA (Mean Descrease in Accuracy)</h3>
<p>This looks are more how the model would do if we removed the variable in question from the model.</p>
<p>A negative MDA means that the model would do better without the variable.</p>
<p>It is more robust and we need to pay more attention to this than MDI.</p>
</section>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>model_3rd3 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"model_3rd3.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 7022 Columns: 20
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (20): week, ydstogo, yardline_100, posteam_timeouts_remaining, defteam_t...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model_4th3 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"model_4th3.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 4226 Columns: 19
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (19): week, attempt, ydstogo, yardline_100, minutes_remaining, posteam_t...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<section id="points-about-the-data" class="level3">
<h3 class="anchored" data-anchor-id="points-about-the-data">Points about the data</h3>
<ul>
<li>week 1 was removed</li>
<li>The data has been prepared for OLS.</li>
<li>The data sets have no NAs (temp and wind where removed to acheive this)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>model_4th3 <span class="ot">&lt;-</span> model_4th3 <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    attempt,             <span class="co"># Target variable: Whether coach elected to go for it on 4th down (1/0) (0 = punt or field goal)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Game situation</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    down1_pct,           <span class="co"># run % on 1st down</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    down2_pct,           <span class="co"># Run % on 2nd down </span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    down3_pct,           <span class="co"># Run % on 3rd down</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">opp_scss =</span> successes,            <span class="co"># Number of successful 4th down attempts the opposing team had last game</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">opp_fails =</span> failures,            <span class="co"># Number of failed 4th down attempts the opposing team had last game</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    score_diff,          <span class="co"># Point differential (positive = winning)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_rem =</span> minutes_remaining,   <span class="co"># Minutes remaining in game</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Play specifics </span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    ydstogo,            <span class="co"># Yards needed for first down</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    yardline_100,       <span class="co"># Distance from opponent's endzone</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Game management</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">offtimes =</span> posteam_timeouts_remaining,  <span class="co"># Offensive team's timeouts left</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">deftimes =</span> defteam_timeouts_remaining,  <span class="co"># Defensive team's timeouts left</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Game context</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    week,               <span class="co"># Week of the season</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    prep_days,          <span class="co"># Days to prepare for game </span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    home,               <span class="co"># Whether team is home (1/0) (0 = away)</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    dome,               <span class="co"># Whether game is in dome (1/0) (0 = outdoor or open)</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Play type indicators</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    KICKOFF,            <span class="co"># If the team received the ball from the opponent via kickoff (1/0)</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    PUNT,               <span class="co"># If the team received the ball from the opponent via a punt (1/0)</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if kickoff and punt are both 0 then the team received the ball from the opponent via a different way</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    random_var          <span class="co"># Random variable for analysis</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>model_3rd3 <span class="ot">&lt;-</span> model_3rd3 <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    converted,            <span class="co"># Target variable: Whether the conversion was successful (1/0)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Game situation</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    down1_pct,           <span class="co"># run % on 1st down</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    down2_pct,           <span class="co"># Run % on 2nd down</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    down3_pct,           <span class="co"># Run % on 3rd down</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">opp_scss =</span> successes,           <span class="co"># Number of successful 4th down attempts the oposing team had last game</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">opp_fails =</span> failures,            <span class="co"># Number of failed 4th down attempts the oposing team had last game</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    score_diff,          <span class="co"># Point differential (positive = winning)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_rem =</span> minutes_remaining,   <span class="co"># Minutes remaining in game</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Play specifics</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    ydstogo,            <span class="co"># Yards needed for first down</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    yardline_100,       <span class="co"># Distance from opponent's endzone</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    rush,               <span class="co"># Whether it's a rushing play (1/0) (0 = pass)</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Game management</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">offtimes =</span> posteam_timeouts_remaining,  <span class="co"># Offensive team's timeouts left</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">deftimes =</span> defteam_timeouts_remaining,  <span class="co"># Defensive team's timeouts left</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Game context</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    week,               <span class="co"># Week of the season</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    prep_days,          <span class="co"># Days to prepare for game</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    home,               <span class="co"># Whether team is home (1/0) (0 = away)</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    dome,               <span class="co"># Whether game is in dome (1/0) (0 = outdoor or open)</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Play type indicators</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    KICKOFF,            <span class="co"># If the team received the ball from the opponent via kickoff (1/0)</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    PUNT,               <span class="co"># If the team received the ball from the opponent via a punt (1/0)</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if kickoff and punt are both 0 then the team received the ball from the opponent via a different way </span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    random_var          <span class="co"># Random variable for analysis</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(model_3rd3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 7,022
Columns: 20
$ converted    &lt;dbl&gt; 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, …
$ down1_pct    &lt;dbl&gt; 72.0, 72.0, 63.2, 72.0, 63.2, 72.0, 72.0, 72.0, 63.2, 63.…
$ down2_pct    &lt;dbl&gt; 61.1, 61.1, 23.5, 61.1, 23.5, 61.1, 61.1, 61.1, 23.5, 23.…
$ down3_pct    &lt;dbl&gt; 20.0, 20.0, 13.3, 20.0, 13.3, 20.0, 20.0, 20.0, 13.3, 13.…
$ opp_scss     &lt;dbl&gt; 0, 0, 1, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, …
$ opp_fails    &lt;dbl&gt; 3, 3, 5, 3, 5, 3, 3, 3, 5, 5, 5, 3, 5, 3, 5, 5, 5, 5, 3, …
$ score_diff   &lt;dbl&gt; 0, 0, -7, 7, -7, 7, 0, 0, -3, -3, -3, 0, -3, 3, -10, -10,…
$ min_rem      &lt;dbl&gt; 57.450000, 53.400000, 50.450000, 48.450000, 46.900000, 43…
$ ydstogo      &lt;dbl&gt; 2, 4, 8, 10, 9, 5, 1, 3, 2, 1, 5, 29, 2, 3, 3, 4, 3, 3, 3…
$ yardline_100 &lt;dbl&gt; 56, 10, 73, 41, 50, 73, 55, 27, 36, 16, 9, 32, 23, 3, 68,…
$ rush         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, …
$ offtimes     &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 2, 3, 2, 2, 2, 2, 3, …
$ deftimes     &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 3, 2, 3, 3, 3, 3, 2, …
$ week         &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
$ prep_days    &lt;dbl&gt; 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, …
$ home         &lt;dbl&gt; 0, 0, 1, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, …
$ dome         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ KICKOFF      &lt;dbl&gt; 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, …
$ PUNT         &lt;dbl&gt; 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ random_var   &lt;dbl&gt; 1.25208314, -1.02819398, -0.89962433, -1.28980601, 0.2157…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(model_4th3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,226
Columns: 19
$ attempt      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, …
$ down1_pct    &lt;dbl&gt; 63.2, 72.0, 63.2, 72.0, 72.0, 63.2, 72.0, 63.2, 72.0, 63.…
$ down2_pct    &lt;dbl&gt; 23.5, 61.1, 23.5, 61.1, 61.1, 23.5, 61.1, 23.5, 61.1, 23.…
$ down3_pct    &lt;dbl&gt; 13.3, 20.0, 13.3, 20.0, 20.0, 13.3, 20.0, 13.3, 20.0, 13.…
$ opp_scss     &lt;dbl&gt; 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
$ opp_fails    &lt;dbl&gt; 5, 3, 5, 3, 3, 5, 3, 5, 3, 5, 3, 3, 1, 1, 3, 1, 1, 3, 1, …
$ score_diff   &lt;dbl&gt; -7, 7, -7, 7, 0, -3, 0, -10, 10, -10, 0, -4, 4, -3, 3, -3…
$ min_rem      &lt;dbl&gt; 50.366667, 48.383333, 46.300000, 43.516667, 39.316667, 33…
$ ydstogo      &lt;dbl&gt; 8, 10, 8, 5, 2, 5, 19, 5, 4, 4, 5, 6, 24, 8, 1, 20, 15, 1…
$ yardline_100 &lt;dbl&gt; 73, 41, 49, 73, 26, 9, 22, 70, 63, 45, 8, 22, 64, 73, 72,…
$ offtimes     &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 0, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, …
$ deftimes     &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 1, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, …
$ week         &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
$ prep_days    &lt;dbl&gt; 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, …
$ home         &lt;dbl&gt; 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0, …
$ dome         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ KICKOFF      &lt;dbl&gt; 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, …
$ PUNT         &lt;dbl&gt; 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, …
$ random_var   &lt;dbl&gt; 0.75254054, 0.29222721, -0.61125853, -0.55995385, -0.9689…</code></pre>
</div>
</div>
<p>Scale the non-binary data without changing names</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale non-binary variables while preserving column names</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>model_3rd3 <span class="ot">&lt;-</span> model_3rd3 <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(down1_pct, down2_pct, down3_pct, opp_scss, opp_fails, score_diff, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                  min_rem, ydstogo, yardline_100, prep_days, random_var), scale))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>model_4th3 <span class="ot">&lt;-</span> model_4th3 <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(down1_pct, down2_pct, down3_pct, opp_scss, opp_fails, score_diff, </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                  min_rem, ydstogo, yardline_100, prep_days, random_var), scale))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ols" class="level2">
<h2 class="anchored" data-anchor-id="ols">OLS</h2>
<section id="th-down-will-the-coach-attempt-to-go-for-it" class="level3">
<h3 class="anchored" data-anchor-id="th-down-will-the-coach-attempt-to-go-for-it">4th down “will the coach attempt to go for it?”</h3>
<p>The OLS (variances) we are using ignore Heteroskedasticity Autocorrelation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit OLS model</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>OLS_4th <span class="ot">&lt;-</span> <span class="fu">lm</span>(attempt <span class="sc">~</span> ., <span class="at">data =</span> model_4th3)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(OLS_4th)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = attempt ~ ., data = model_4th3)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.8202 -0.2767 -0.1295  0.2485  1.2573 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   0.3161899  0.0322851   9.794  &lt; 2e-16 ***
down1_pct     0.0078331  0.0065010   1.205  0.22831    
down2_pct    -0.0033821  0.0068656  -0.493  0.62231    
down3_pct     0.0098403  0.0064699   1.521  0.12835    
opp_scss      0.0073347  0.0060928   1.204  0.22872    
opp_fails     0.0004542  0.0060054   0.076  0.93971    
score_diff   -0.0905270  0.0063099 -14.347  &lt; 2e-16 ***
min_rem      -0.0763792  0.0064324 -11.874  &lt; 2e-16 ***
ydstogo      -0.1210474  0.0061527 -19.674  &lt; 2e-16 ***
yardline_100 -0.0554073  0.0062393  -8.880  &lt; 2e-16 ***
offtimes     -0.0560553  0.0087659  -6.395 1.78e-10 ***
deftimes      0.0247166  0.0085634   2.886  0.00392 ** 
week          0.0024256  0.0011565   2.097  0.03603 *  
prep_days    -0.0029414  0.0060232  -0.488  0.62533    
home         -0.0002153  0.0120360  -0.018  0.98573    
dome          0.0185497  0.0155098   1.196  0.23176    
KICKOFF      -0.0230719  0.0183747  -1.256  0.20932    
PUNT         -0.0214659  0.0182423  -1.177  0.23938    
random_var   -0.0068487  0.0059426  -1.152  0.24919    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3857 on 4207 degrees of freedom
Multiple R-squared:  0.2013,    Adjusted R-squared:  0.1979 
F-statistic: 58.92 on 18 and 4207 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(OLS_4th)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   down1_pct    down2_pct    down3_pct     opp_scss    opp_fails   score_diff 
    1.200415     1.338849     1.188938     1.054388     1.024351     1.130864 
     min_rem      ydstogo yardline_100     offtimes     deftimes         week 
    1.175220     1.075216     1.105727     1.233531     1.273327     1.038284 
   prep_days         home         dome      KICKOFF         PUNT   random_var 
    1.030431     1.028573     1.023460     2.378646     2.242123     1.003042 </code></pre>
</div>
</div>
</section>
<section id="rd-down-will-the-play-convert-to-a-1st-down" class="level3">
<h3 class="anchored" data-anchor-id="rd-down-will-the-play-convert-to-a-1st-down">3rd down “will the play convert to a 1st down?”</h3>
<p>The OLS (variances) we are using ignore Heteroskedasticity Autocorrelation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit OLS model</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>OLS_3rd <span class="ot">&lt;-</span> <span class="fu">lm</span>(converted <span class="sc">~</span> ., <span class="at">data =</span> model_3rd3)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(OLS_3rd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = converted ~ ., data = model_3rd3)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.7205 -0.4003 -0.2132  0.4844  1.2510 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   0.3622512  0.0334632  10.825  &lt; 2e-16 ***
down1_pct     0.0062952  0.0060435   1.042  0.29761    
down2_pct    -0.0052589  0.0063523  -0.828  0.40777    
down3_pct     0.0084129  0.0059925   1.404  0.16039    
opp_scss      0.0003519  0.0056701   0.062  0.95052    
opp_fails    -0.0018781  0.0055904  -0.336  0.73691    
score_diff   -0.0006771  0.0058517  -0.116  0.90788    
min_rem       0.0069106  0.0059443   1.163  0.24505    
ydstogo      -0.1516129  0.0058257 -26.025  &lt; 2e-16 ***
yardline_100  0.0185311  0.0057247   3.237  0.00121 ** 
rush          0.0811025  0.0136165   5.956 2.71e-09 ***
offtimes      0.0064553  0.0085714   0.753  0.45140    
deftimes      0.0009931  0.0088993   0.112  0.91115    
week         -0.0010538  0.0010643  -0.990  0.32214    
prep_days    -0.0074283  0.0055881  -1.329  0.18379    
home          0.0060257  0.0111602   0.540  0.58926    
dome          0.0068512  0.0143268   0.478  0.63251    
KICKOFF       0.0156790  0.0170975   0.917  0.35916    
PUNT         -0.0103309  0.0170306  -0.607  0.54413    
random_var   -0.0002959  0.0055189  -0.054  0.95724    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.462 on 7002 degrees of freedom
Multiple R-squared:  0.1113,    Adjusted R-squared:  0.1089 
F-statistic: 46.14 on 19 and 7002 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(OLS_3rd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   down1_pct    down2_pct    down3_pct     opp_scss    opp_fails   score_diff 
    1.201408     1.327324     1.181197     1.057529     1.028014     1.126347 
     min_rem      ydstogo yardline_100         rush     offtimes     deftimes 
    1.162294     1.116364     1.077976     1.096937     1.169747     1.205813 
        week    prep_days         home         dome      KICKOFF         PUNT 
    1.037002     1.027149     1.024208     1.021095     2.392242     2.247282 
  random_var 
    1.001881 </code></pre>
</div>
</div>
</section>
</section>
<section id="random-forest" class="level2">
<h2 class="anchored" data-anchor-id="random-forest">Random Forest</h2>
<section id="th-down-will-the-coach-attempt-to-go-for-it-1" class="level3">
<h3 class="anchored" data-anchor-id="th-down-will-the-coach-attempt-to-go-for-it-1">4th down “will the coach attempt to go for it?”</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train Random Forest</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>rf4 <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(<span class="fu">as.factor</span>(attempt) <span class="sc">~</span> ., </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> model_4th3,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">importance =</span> <span class="cn">TRUE</span>,  <span class="co"># Calculate both MDI and MDA</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ntree =</span> <span class="dv">1500</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get variable importance measures</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>importance_df <span class="ot">&lt;-</span> <span class="fu">importance</span>(rf4) <span class="sc">%&gt;%</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"Variable"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(MeanDecreaseAccuracy))</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate OOB AUC</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>oob_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf4, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>oob_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(model_4th3<span class="sc">$</span>attempt, oob_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting levels: control = 0, case = 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting direction: controls &lt; cases</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Variable Importance (sorted by Mean Decrease Accuracy):"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Variable Importance (sorted by Mean Decrease Accuracy):"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(importance_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Variable           0           1 MeanDecreaseAccuracy MeanDecreaseGini
1       ydstogo 129.5803903 181.5812907          195.9364494        333.26362
2    score_diff  62.2157147 108.1581483          111.8750307        183.26708
3       min_rem  64.7087145 105.4171045          110.8973368        199.81002
4  yardline_100  48.8847928 108.6697961           99.4849097        206.10690
5      offtimes  19.8325433  24.8017127           30.6283672         36.20604
6      deftimes  23.2566266   3.0152150           22.6309742         26.93683
7          week  -0.7452899   8.8207525            4.4024439         60.11121
8     down2_pct   2.0866261   3.1736390            3.6023777         77.56816
9     down1_pct  -0.6646903   6.1095623            2.9279802         80.43272
10    down3_pct  -2.4978125   8.3017148            2.9054179         80.22203
11         home  -1.0063994   5.6076623            2.4215218         14.93485
12      KICKOFF   4.0542684  -1.8238247            2.3841109         14.02422
13         PUNT  -2.6235467   2.5570161           -0.6659458         12.88669
14    prep_days  -2.8820342   1.5062283           -1.5958319         34.58355
15     opp_scss  -3.6419250   2.6120043           -1.6263166         37.38673
16         dome  -1.7689874  -1.1375464           -2.1407841         10.31484
17   random_var  -2.3872106  -0.5437249           -2.2647873        108.96953
18    opp_fails  -6.9347639   3.9738150           -3.5240689         39.27497</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"OOB AUC:"</span>, <span class="fu">round</span>(oob_auc, <span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "OOB AUC: 0.882"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot variable importance</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf4,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">sort =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Variable Importance Plot"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">n.var =</span> <span class="fu">min</span>(<span class="dv">20</span>, <span class="fu">ncol</span>(model_4th3)<span class="sc">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Proposal_v1_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ROC object from existing predictions</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>roc_4th <span class="ot">&lt;-</span> <span class="fu">roc</span>(model_4th3<span class="sc">$</span>attempt, oob_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting levels: control = 0, case = 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting direction: controls &lt; cases</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame for plotting</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>roc_df_4th <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">FPR =</span> <span class="dv">1</span> <span class="sc">-</span> roc_4th<span class="sc">$</span>specificities,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">TPR =</span> roc_4th<span class="sc">$</span>sensitivities</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(roc_df_4th, <span class="fu">aes</span>(<span class="at">x =</span> FPR, <span class="at">y =</span> TPR)) <span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"#E41A1C"</span>) <span class="sc">+</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.75</span>, <span class="at">y =</span> <span class="fl">0.25</span>, </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"AUC: %.3f"</span>, oob_auc)) <span class="sc">+</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ROC Curve for 4th Down Attempt Predictions"</span>,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"False Positive Rate"</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"True Positive Rate"</span>) <span class="sc">+</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Proposal_v1_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that these partial dependency plots tell a story more about how the RF model uses the variable. It could still be used wrong/given too much weight by the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get scaling attributes for score_diff from the original data FIRST</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>score_diff_center <span class="ot">&lt;-</span> <span class="fu">attr</span>(model_4th3<span class="sc">$</span>score_diff, <span class="st">"scaled:center"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>score_diff_scale <span class="ot">&lt;-</span> <span class="fu">attr</span>(model_4th3<span class="sc">$</span>score_diff, <span class="st">"scaled:scale"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a grid of score_diff values</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>grid_points <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(model_4th3<span class="sc">$</span>score_diff), <span class="fu">max</span>(model_4th3<span class="sc">$</span>score_diff), <span class="at">length.out =</span> <span class="dv">50</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction data frame</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> model_4th3[<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(grid_points)), ]</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>score_diff <span class="ot">&lt;-</span> grid_points</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf4, pred_data, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plot data</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_diff =</span> grid_points <span class="sc">*</span> score_diff_scale <span class="sc">+</span> score_diff_center,  <span class="co"># Convert back to original scale</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">probability =</span> predictions</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plot</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> score_diff, <span class="at">y =</span> probability)) <span class="sc">+</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#E41A1C"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Score Differential on 4th Down Attempt Probability"</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Score Differential (Points)"</span>,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Probability of 4th Down Attempt"</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Proposal_v1_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is a very good AUC despite missing how good the teams are. This makes sense though since NFL teams are trying to make the right decision.</p>
</section>
<section id="rd-down-will-the-play-convert-to-a-1st-down-1" class="level3">
<h3 class="anchored" data-anchor-id="rd-down-will-the-play-convert-to-a-1st-down-1">3rd down “will the play convert to a 1st down?”</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train Random Forest</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>rf3 <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(<span class="fu">as.factor</span>(converted) <span class="sc">~</span> ., </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> model_3rd3,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">importance =</span> <span class="cn">TRUE</span>,  <span class="co"># Calculate both MDI and MDA</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ntree =</span> <span class="dv">1500</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get variable importance measures</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>importance_df <span class="ot">&lt;-</span> <span class="fu">importance</span>(rf3) <span class="sc">%&gt;%</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"Variable"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(MeanDecreaseAccuracy))</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate OOB AUC</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>oob_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf3, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>oob_auc <span class="ot">&lt;-</span> <span class="fu">auc</span>(model_3rd3<span class="sc">$</span>converted, oob_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting levels: control = 0, case = 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting direction: controls &lt; cases</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Variable Importance (sorted by Mean Decrease Accuracy):"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Variable Importance (sorted by Mean Decrease Accuracy):"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(importance_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Variable          0           1 MeanDecreaseAccuracy MeanDecreaseGini
1       ydstogo 85.3644152 116.7665246          138.5979928        454.74706
2          rush  5.0502718  27.1338845           24.2757007         61.67652
3  yardline_100 12.7480333  -3.9071422            7.5901813        320.36524
4       min_rem  4.9583690   0.9096033            4.5656334        353.08562
5    score_diff  1.5591824   0.8936117            1.8492188        231.92666
6       KICKOFF -3.4128584   6.4866708            1.6887604         43.98508
7          week  0.7805226   1.0415674            1.2988775        186.56162
8     down3_pct  4.8530987  -3.8458049            1.2237366        251.14155
9     opp_fails -1.5561765   3.1576539            0.9063699        124.26972
10     opp_scss -0.9235072   2.5072081            0.8382594        115.47544
11    down2_pct  0.2460644   0.9046173            0.8175787        245.12477
12     deftimes  1.6531107  -1.2247312            0.5496247         62.95941
13    prep_days -0.4824555  -0.9171305           -0.9458126        109.41284
14         PUNT -3.2561167   0.8302219           -2.0611462         42.86718
15         dome -3.2452500   0.7103600           -2.0807577         32.63629
16   random_var -0.7191775  -2.6964643           -2.2573691        351.12620
17         home -4.3267056  -0.1367077           -3.4719828         42.84991
18    down1_pct -5.9310130   1.0764108           -4.2038761        245.70276
19     offtimes -4.5087584  -1.9444284           -5.0068308         60.39700</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"OOB AUC:"</span>, <span class="fu">round</span>(oob_auc, <span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "OOB AUC: 0.669"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot variable importance</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf3,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">sort =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Variable Importance Plot"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">n.var =</span> <span class="fu">min</span>(<span class="dv">20</span>, <span class="fu">ncol</span>(model_3rd3)<span class="sc">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Proposal_v1_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ROC object from existing predictions</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>roc_3rd <span class="ot">&lt;-</span> <span class="fu">roc</span>(model_3rd3<span class="sc">$</span>converted, oob_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting levels: control = 0, case = 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting direction: controls &lt; cases</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame for plotting</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>roc_df_3rd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">FPR =</span> <span class="dv">1</span> <span class="sc">-</span> roc_3rd<span class="sc">$</span>specificities,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">TPR =</span> roc_3rd<span class="sc">$</span>sensitivities</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(roc_df_3rd, <span class="fu">aes</span>(<span class="at">x =</span> FPR, <span class="at">y =</span> TPR)) <span class="sc">+</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"#377EB8"</span>) <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.75</span>, <span class="at">y =</span> <span class="fl">0.25</span>, </span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"AUC: %.3f"</span>, oob_auc)) <span class="sc">+</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ROC Curve for 3rd Down Conversion Predictions"</span>,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"False Positive Rate"</span>,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"True Positive Rate"</span>) <span class="sc">+</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Proposal_v1_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is a bad AUC which currently makes sense as it is a baseline. This example does not have how good the teams or players are.</p>
<p>Note that these partial dependency plots tell a story more about how the RF model uses the variable. It could still be used wrong/given to much weight by the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get scaling attributes for score_diff from the original data FIRST</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>score_diff_center <span class="ot">&lt;-</span> <span class="fu">attr</span>(model_3rd3<span class="sc">$</span>score_diff, <span class="st">"scaled:center"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>score_diff_scale <span class="ot">&lt;-</span> <span class="fu">attr</span>(model_3rd3<span class="sc">$</span>score_diff, <span class="st">"scaled:scale"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a grid of score_diff values</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>grid_points <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(model_3rd3<span class="sc">$</span>score_diff), <span class="fu">max</span>(model_3rd3<span class="sc">$</span>score_diff), <span class="at">length.out =</span> <span class="dv">50</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction data frame</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> model_3rd3[<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(grid_points)), ]</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>pred_data<span class="sc">$</span>score_diff <span class="ot">&lt;-</span> grid_points</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf3, pred_data, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plot data</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a> <span class="at">score_diff =</span> grid_points <span class="sc">*</span> score_diff_scale <span class="sc">+</span> score_diff_center,  <span class="co"># Convert back to original scale</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a> <span class="at">probability =</span> predictions</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plot</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> score_diff, <span class="at">y =</span> probability)) <span class="sc">+</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a> <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#377EB8"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a> <span class="fu">labs</span>(</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>   <span class="at">title =</span> <span class="st">"Effect of Score Differential on 3rd Down Conversion Probability"</span>,</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>   <span class="at">x =</span> <span class="st">"Score Differential (Points)"</span>,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>   <span class="at">y =</span> <span class="st">"Probability of 3rd Down Conversion"</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a> ) <span class="sc">+</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a> <span class="fu">theme</span>(</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>   <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>   <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Proposal_v1_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="references" class="level1 unnumbered">
<h1 class="unnumbered">References</h1>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>